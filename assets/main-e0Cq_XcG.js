(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}})();const A=document.getElementById("c"),he={alpha:!1,desynchronized:!0,willReadFrequently:!1};typeof OffscreenCanvasRenderingContext2D<"u"&&"colorSpace"in OffscreenCanvasRenderingContext2D.prototype&&(he.colorSpace="display-p3");const d=A.getContext("2d",he);d.imageSmoothingEnabled=!0;d.imageSmoothingQuality="high";let E=100,C=100,I=1,Z=50,ee=50;function V(){const n=window.innerWidth,e=window.innerHeight;window.matchMedia("(max-width: 768px)").matches?I=Math.min(window.devicePixelRatio||1,1.5):I=Math.min(window.devicePixelRatio||1,2),E=n,C=e,A.width=n*I,A.height=e*I,A.style.width=n+"px",A.style.height=e+"px",d.setTransform(I,0,0,I,0,0),Z=n/2,ee=e/2}function ue(){window.visualViewport&&(window.visualViewport.addEventListener("resize",V),window.visualViewport.addEventListener("scroll",V)),window.addEventListener("orientationchange",()=>{V(),setTimeout(V,300)}),window.addEventListener("resize",V,{passive:!0})}const t={slices:10,circles:7,baseRadius:.35,swirlSpeed:.2,hueSpeed:35,sizeMod:.18,luminance:1,hueDrift:0};function de(){window.matchMedia("(min-width: 769px) and (pointer: fine)").matches&&(t.slices=14,t.circles=9,t.baseRadius=.32,t.swirlSpeed=.25,t.hueSpeed=40,t.sizeMod=.16,t.luminance=1,t.hueDrift=0)}let F=null,G=null;const l={rotationVelocity:0,lastRotationTime:0,lastRotationAngle:0,velocityHistory:[],shakeMagnitude:0,shakeDecay:.9,lastShakeTime:0,pulsePhase:0,pulseSpeed:0,originalSpeed:null,luminance:.6,luminanceTarget:.6,scale:1,scaleTarget:1,scaleVelocity:0,mode:"Calm",debugHUD:!1};function M(n,e){F&&F.onUserInteraction&&F.onUserInteraction(n,e)}function q(n,e,s){return Math.max(e,Math.min(s,n))}function me(n){G=n}function pe(n=null){F=n,"ontouchstart"in window||window.addEventListener("pointermove",e=>{const s=(e.clientX/window.innerWidth-.5)*2,a=(e.clientY/window.innerHeight-.5)*2,i=.05+Math.abs(s)*.6,o=6+Math.floor(Math.abs(a)*18);t.swirlSpeed=i,t.slices=o,M("swirlSpeed",i),M("slices",o)},{passive:!0})}function fe(n,e=null){F=e;const s=new Hammer.Manager(n,{touchAction:"none",recognizers:[[Hammer.Pan,{direction:Hammer.DIRECTION_ALL,threshold:0}],[Hammer.Pinch,{enable:!0}],[Hammer.Rotate,{enable:!0}],[Hammer.Swipe,{direction:Hammer.DIRECTION_ALL,velocity:.3}],[Hammer.Tap,{event:"doubletap",taps:2}],[Hammer.Tap,{event:"tripletap",taps:3}],[Hammer.Press,{time:400}]]});s.get("pinch").set({enable:!0}),s.get("rotate").set({enable:!0}),s.on("panstart",a=>{a.center.x,a.center.y,l.velocityHistory=[],l.lastRotationTime=Date.now();const i=window.innerWidth/2,o=window.innerHeight/2;l.lastRotationAngle=Math.atan2(a.center.y-o,a.center.x-i)}),s.on("panmove",a=>{const i=Date.now(),o=Math.max(1,i-l.lastRotationTime);if(a.pointers.length===3){l.luminanceTarget=q(l.luminanceTarget-a.deltaY/800,.3,1),M("luminance",l.luminanceTarget);return}if(a.pointers.length===1){const r=window.innerWidth/2,b=window.innerHeight/2;let c=Math.atan2(a.center.y-b,a.center.x-r)-l.lastRotationAngle;c>Math.PI&&(c-=2*Math.PI),c<-Math.PI&&(c+=2*Math.PI);const m=c/(o/1e3),p=Math.sqrt(Math.pow(a.center.x-r,2)+Math.pow(a.center.y-b,2)),w=Math.min(window.innerWidth,window.innerHeight),y=w*.2,S=w*.45;if(p>y&&p<S&&Math.abs(c)>1e-4){let v=m*.5;Math.abs(m)>3&&(v*=1.2),t.swirlSpeed=t.swirlSpeed*.7+v*.3,t.swirlSpeed=Math.max(-3,Math.min(3,t.swirlSpeed)),M("swirlSpeed",t.swirlSpeed),l.rotationVelocity=0,l.pulseSpeed=.1}}a.center.x,a.center.y,l.lastRotationAngle=Math.atan2(a.center.y-window.innerHeight/2,a.center.x-window.innerWidth/2),l.lastRotationTime=i}),s.on("panend",a=>{l.rotationVelocity=t.swirlSpeed*2}),s.on("swipe",a=>{const i=Math.sqrt(a.velocityX*a.velocityX+a.velocityY*a.velocityY);if(Math.abs(a.velocityY)>Math.abs(a.velocityX))if(a.velocityY<0){const o=Math.min(.6,t.baseRadius*1.4);t.baseRadius=o,M("baseRadius",o);const r=Math.min(.5,t.sizeMod*1.3);t.sizeMod=r,M("sizeMod",r),l.pulseSpeed=i*.8}else{const o=Math.max(.1,t.baseRadius*.6);t.baseRadius=o,M("baseRadius",o);const r=Math.max(.05,t.sizeMod*.7);t.sizeMod=r,M("sizeMod",r),l.pulseSpeed=i*.8}if(Math.abs(a.velocityX)>Math.abs(a.velocityY)){const o=a.velocityX>0?1:-1;l.rotationVelocity=o*i*2,t.swirlSpeed+=o*i*.3,t.swirlSpeed=Math.max(-1.5,Math.min(1.5,t.swirlSpeed)),M("swirlSpeed",t.swirlSpeed)}}),s.on("pinch pinchmove",a=>{l.scaleTarget=q(a.scale,.6,1.8),M("scaleTarget",l.scaleTarget)}),s.on("rotate rotatemove",a=>{t.hueDrift=q(a.rotation/180,-1,1),M("hueDrift",t.hueDrift)}),s.on("doubletap",a=>{const i=["Calm","Pulse","Rave"],o=i.indexOf(l.mode);l.mode=i[(o+1)%i.length],M("mode",l.mode),l.pulseSpeed=.5}),s.on("tripletap",a=>{l.shakeMagnitude=20,l.lastShakeTime=Date.now();const i=Math.floor(Math.random()*16)+4,o=Math.floor(Math.random()*8)+3,r=Math.random()*60+20;t.slices=i,t.circles=o,t.hueSpeed=r,M("slices",i),M("circles",o),M("hueSpeed",r)}),s.on("press",a=>{l.debugHUD=!l.debugHUD,M("debugHUD",l.debugHUD),G&&G.toggle()}),n.addEventListener("touchstart",a=>a.preventDefault(),{passive:!1}),n.addEventListener("touchmove",a=>a.preventDefault(),{passive:!1})}function Ve(n){Math.abs(l.rotationVelocity)>.001&&(t.swirlSpeed=l.rotationVelocity,M("swirlSpeed",t.swirlSpeed),l.rotationVelocity*=.92,Math.abs(l.rotationVelocity)<.05&&(l.rotationVelocity=0,t.swirlSpeed=0,M("swirlSpeed",0)));const e=(l.scaleTarget-l.scale)*.22;if(l.scaleVelocity=(l.scaleVelocity+e)*.88,l.scale+=l.scaleVelocity,t.baseRadius=q(l.scale*.35,.1,.6),M("baseRadius",t.baseRadius),l.luminance+=(l.luminanceTarget-l.luminance)*.1,t.luminance=l.luminance,M("luminance",t.luminance),l.pulseSpeed>.01){l.pulsePhase+=l.pulseSpeed*n*.01;const s=Math.sin(l.pulsePhase)*.05,a=Math.max(.1,Math.min(.5,t.sizeMod+s));t.sizeMod=a,M("sizeMod",a),l.pulseSpeed*=.98}if(l.shakeMagnitude>.1){l.originalSpeed||(l.originalSpeed=t.swirlSpeed);const s=(Math.random()-.5)*l.shakeMagnitude*.002,a=Math.max(0,Math.min(2,l.originalSpeed+s));t.swirlSpeed=a,M("swirlSpeed",a),l.shakeMagnitude*=l.shakeDecay,l.shakeMagnitude<.1&&(t.swirlSpeed=l.originalSpeed,l.originalSpeed=null)}}function ge(n=null){F=n,"DeviceMotionEvent"in window&&window.addEventListener("devicemotion",e=>{if(e.accelerationIncludingGravity){const s=e.accelerationIncludingGravity.x,a=e.accelerationIncludingGravity.y,i=s/10*.1,o=Math.max(0,Math.min(1,t.swirlSpeed+i));t.swirlSpeed=o,M("swirlSpeed",o);const r=Math.abs(a)/10;if(r>.3){const b=Math.max(4,Math.min(24,Math.round(6+r*18)));t.slices=b,M("slices",b)}}},{passive:!0})}let X=null;function f(n,e){X&&X.onUserInteraction&&X.onUserInteraction(n,e)}const g={mouseX:0,mouseY:0,targetMouseX:0,targetMouseY:0,smoothing:.15,wheelAccumulator:0,wheelDecay:.95,lastWheelTime:0,hoverEffect:0,hoverDecay:.98};function be(n,e=null){X=e,n.addEventListener("mousemove",s=>{g.targetMouseX=(s.clientX/window.innerWidth-.5)*2,g.targetMouseY=(s.clientY/window.innerHeight-.5)*2,g.hoverEffect=Math.min(1,g.hoverEffect+.1)}),n.addEventListener("mouseleave",()=>{g.targetMouseX=0,g.targetMouseY=0,g.hoverEffect=0}),n.addEventListener("wheel",s=>{s.preventDefault();const a=Date.now();if(g.lastWheelTime=a,g.wheelAccumulator+=s.deltaY*.001,s.shiftKey){const i=Math.max(3,Math.min(15,Math.round(t.circles-s.deltaY*.01)));t.circles=i,f("circles",i)}else if(s.ctrlKey||s.metaKey){const i=Math.max(.05,Math.min(.5,t.sizeMod-s.deltaY*5e-4));t.sizeMod=i,f("sizeMod",i)}else if(s.altKey){const i=Math.max(5,Math.min(150,t.hueSpeed-s.deltaY*.1));t.hueSpeed=i,f("hueSpeed",i)}else{const i=Math.max(4,Math.min(32,Math.round(t.slices-s.deltaY*.02)));t.slices=i,f("slices",i)}},{passive:!1}),n.addEventListener("click",s=>{const a=s.clientX/window.innerWidth,i=s.clientY/window.innerHeight;if(a<.5&&i<.5){const o=Math.floor(Math.random()*16)+6,r=Math.floor(Math.random()*8)+4;t.slices=o,t.circles=r,f("slices",o),f("circles",r)}else if(a>=.5&&i<.5){const o=(Math.random()-.5)*.8,r=Math.random()*80+20;t.swirlSpeed=o,t.hueSpeed=r,f("swirlSpeed",o),f("hueSpeed",r)}else if(a<.5&&i>=.5){const o=Math.random()*.3+.1,r=Math.random()*.3+.2;t.sizeMod=o,t.baseRadius=r,f("sizeMod",o),f("baseRadius",r)}else{const o=Math.floor(Math.random()*24)+4,r=Math.floor(Math.random()*10)+3,b=(Math.random()-.5)*1,h=Math.random()*100+10,c=Math.random()*.4+.1;t.slices=o,t.circles=r,t.swirlSpeed=b,t.hueSpeed=h,t.sizeMod=c,f("slices",o),f("circles",r),f("swirlSpeed",b),f("hueSpeed",h),f("sizeMod",c)}}),document.addEventListener("keydown",s=>{if(document.activeElement===n||document.activeElement===document.body)switch(s.key.toLowerCase()){case"r":Object.assign(t,{slices:8,circles:6,swirlSpeed:.05,hueSpeed:40,sizeMod:.2,baseRadius:.25}),f("slices",t.slices),f("circles",t.circles),f("swirlSpeed",t.swirlSpeed);break;case" ":s.preventDefault();const a=Math.abs(t.swirlSpeed)<.01?.15:0;t.swirlSpeed=a,f("swirlSpeed",a);break;case"arrowup":s.preventDefault();const i=Math.min(32,t.slices+1);t.slices=i,f("slices",i);break;case"arrowdown":s.preventDefault();const o=Math.max(4,t.slices-1);t.slices=o,f("slices",o);break;case"arrowright":s.preventDefault();const r=Math.min(15,t.circles+1);t.circles=r,f("circles",r);break;case"arrowleft":s.preventDefault();const b=Math.max(3,t.circles-1);t.circles=b,f("circles",b);break}})}function Ae(){g.mouseX+=(g.targetMouseX-g.mouseX)*g.smoothing,g.mouseY+=(g.targetMouseY-g.mouseY)*g.smoothing;const n=g.mouseX*.3,e=t.swirlSpeed+n*.02;t.swirlSpeed=e,f("swirlSpeed",e);const s=Math.abs(g.mouseY)*.5;if(s>.1){const a=8+Math.floor(s*8),i=Math.max(4,Math.min(20,a));t.slices=i,f("slices",i)}if(Math.abs(g.wheelAccumulator)>.001){const a=t.swirlSpeed+g.wheelAccumulator*.1;t.swirlSpeed=a,f("swirlSpeed",a),g.wheelAccumulator*=g.wheelDecay}if(g.hoverEffect>.01){const a=Math.sin(Date.now()*.005)*g.hoverEffect*.02,i=Math.max(.05,Math.min(.5,t.sizeMod+a));t.sizeMod=i,f("sizeMod",i),g.hoverEffect*=g.hoverDecay}}class ye{constructor(){this.audioContext=null,this.analyser=null,this.microphone=null,this.musicSource=null,this.dataArray=null,this.bufferLength=null,this.isActive=!1,this.isMicrophoneMode=!1,this.isMusicMode=!1,this.musicPlayer=null,this.volume=0,this.bass=0,this.mid=0,this.treble=0,this.peak=0,this.beatDetected=!1,this.beatThreshold=.85,this.beatDecay=.99,this.beatMin=.2,this.lastBeatTime=0,this.beatInterval=0,this.smoothingLayers={volumeSmooth1:0,bassSmooth1:0,midSmooth1:0,trebleSmooth1:0,volumeSmooth2:0,bassSmooth2:0,midSmooth2:0,trebleSmooth2:0,volumeFinal:0,bassFinal:0,midFinal:0,trebleFinal:0},this.lastUpdateTime=performance.now()}lerp(e,s,a,i=1){const o=1-Math.pow(1-a,i*60/1e3);return e+(s-e)*o}async initAudioContext(){if(this.audioContext)return!0;try{return this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.95,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),!0}catch(e){return console.error("Failed to create audio context:",e),!1}}async startMicrophone(){try{if(!await this.initAudioContext())return!1;if(this.stopAllSources(),navigator.permissions)try{if((await navigator.permissions.query({name:"microphone"})).state==="denied")return alert("Microphone access denied. Please enable it in your browser settings and try again."),!1}catch{console.log("Permissions API not supported, continuing...")}const e={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1}};let s;try{s=await navigator.mediaDevices.getUserMedia(e)}catch{try{s=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(i){return console.error("Microphone access failed:",i),i.name==="NotAllowedError"?alert(`🎤 Microphone access denied. Please:

1. Refresh the page
2. Click "Allow" when prompted
3. Check your browser settings if needed`):i.name==="NotFoundError"?alert("🎤 No microphone found. Please check your device has a working microphone."):i.name==="NotReadableError"?alert("🎤 Microphone is busy or not available. Please close other apps using the microphone and try again."):alert("🎤 Could not access microphone. Please check your device settings and try again."),!1}}return this.microphone=this.audioContext.createMediaStreamSource(s),this.microphone.connect(this.analyser),this.microphoneStream=s,this.isMicrophoneMode=!0,this.isMusicMode=!1,this.isActive=!0,this.lastUpdateTime=performance.now(),this.analyze(),!0}catch(e){return console.error("Failed to access microphone:",e),alert("🎤 Microphone setup failed. Please refresh the page and try again."),!1}}async startMusic(){try{if(!await this.initAudioContext())return!1;if(this.stopAllSources(),this.musicPlayer=document.getElementById("musicPlayer"),!this.musicPlayer)return console.error("Music player element not found"),!1;this.audioContext.state==="suspended"&&await this.audioContext.resume();const e=5,s=[100,500,1e3,2e3,3e3];let a=null;for(let i=0;i<=e;i++)try{if(i>0&&(console.log(`🎵 Retry attempt ${i}/${e} to load audio...`),this.musicPlayer.load(),i<s.length&&await new Promise(o=>setTimeout(o,s[i-1]))),this.musicPlayer.readyState<2&&await new Promise((o,r)=>{const b=setTimeout(()=>{r(new Error("Audio load timeout"))},5e3),h=()=>{clearTimeout(b),m(),o()},c=p=>{clearTimeout(b),m(),r(p)},m=()=>{this.musicPlayer.removeEventListener("canplay",h),this.musicPlayer.removeEventListener("error",c)};this.musicPlayer.addEventListener("canplay",h,{once:!0}),this.musicPlayer.addEventListener("error",c,{once:!0}),this.musicPlayer.load()}),!this.musicSource)try{this.musicSource=this.audioContext.createMediaElementSource(this.musicPlayer),this.musicSource.connect(this.analyser),this.musicSource.connect(this.audioContext.destination)}catch(o){if(console.log("Audio element already connected, using existing connection"),o.message.includes("already connected"))return console.log("🎵 Using existing audio connection"),this.isMusicMode=!0,this.isMicrophoneMode=!1,this.isActive=!0,this.lastUpdateTime=performance.now(),this.analyze(),!0;throw o}return this.musicPlayer.loop=!0,this.musicPlayer.addEventListener("ended",()=>{this.isMusicMode&&this.musicPlayer.play()}),await this.musicPlayer.play(),console.log("🎵 Audio loaded successfully"),this.isMusicMode=!0,this.isMicrophoneMode=!1,this.isActive=!0,this.lastUpdateTime=performance.now(),this.analyze(),!0}catch(o){a=o,console.warn(`Audio load attempt ${i+1} failed:`,o.message),this.musicSource&&(this.musicSource.disconnect(),this.musicSource=null)}return console.error("🎵 Audio loading failed after all retries:",a),console.log("🎨 Continuing without audio - visualizer will work with user interactions only"),!1}catch(e){return console.error("Failed to start music playback:",e),!1}}stopAllSources(){this.microphone&&(this.microphone.disconnect(),this.microphone=null),this.microphoneStream&&(this.microphoneStream.getTracks().forEach(e=>e.stop()),this.microphoneStream=null),this.musicSource&&(this.musicSource.disconnect(),this.musicSource=null),this.musicPlayer&&!this.musicPlayer.paused&&this.musicPlayer.pause(),this.isMicrophoneMode=!1,this.isMusicMode=!1}stop(){this.stopAllSources(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.isActive=!1}toggleMusic(){if(!this.musicPlayer)return!1;try{return this.musicPlayer.paused?(this.musicPlayer.play(),!0):(this.musicPlayer.pause(),!1)}catch(e){return console.error("Failed to toggle music:",e),null}}isMusicPlaying(){return this.musicPlayer&&!this.musicPlayer.paused}analyze(){if(!this.isActive)return;const e=performance.now(),s=e-this.lastUpdateTime;this.lastUpdateTime=e,this.analyser.getByteFrequencyData(this.dataArray);const a=this.audioContext.sampleRate/2,i=250/a*this.bufferLength,o=2e3/a*this.bufferLength;let r=0,b=0,h=0,c=0,m=0,p=0;for(let u=0;u<this.bufferLength;u++){const H=this.dataArray[u]/255;u<i?(r+=H,c++):u<o?(b+=H,m++):(h+=H,p++)}const w=c>0?r/c:0,y=m>0?b/m:0,S=p>0?h/p:0;this.smoothingLayers.bassSmooth1=this.lerp(this.smoothingLayers.bassSmooth1,w,.15,s),this.smoothingLayers.midSmooth1=this.lerp(this.smoothingLayers.midSmooth1,y,.12,s),this.smoothingLayers.trebleSmooth1=this.lerp(this.smoothingLayers.trebleSmooth1,S,.1,s),this.smoothingLayers.bassSmooth2=this.lerp(this.smoothingLayers.bassSmooth2,this.smoothingLayers.bassSmooth1,.08,s),this.smoothingLayers.midSmooth2=this.lerp(this.smoothingLayers.midSmooth2,this.smoothingLayers.midSmooth1,.06,s),this.smoothingLayers.trebleSmooth2=this.lerp(this.smoothingLayers.trebleSmooth2,this.smoothingLayers.trebleSmooth1,.05,s),this.smoothingLayers.bassFinal=this.lerp(this.smoothingLayers.bassFinal,this.smoothingLayers.bassSmooth2,.04,s),this.smoothingLayers.midFinal=this.lerp(this.smoothingLayers.midFinal,this.smoothingLayers.midSmooth2,.03,s),this.smoothingLayers.trebleFinal=this.lerp(this.smoothingLayers.trebleFinal,this.smoothingLayers.trebleSmooth2,.02,s),this.bass=this.smoothingLayers.bassFinal,this.mid=this.smoothingLayers.midFinal,this.treble=this.smoothingLayers.trebleFinal;const v=(w*3+y*.5+S*.2)/3.7;this.smoothingLayers.volumeSmooth1=this.lerp(this.smoothingLayers.volumeSmooth1,v,.1,s),this.smoothingLayers.volumeSmooth2=this.lerp(this.smoothingLayers.volumeSmooth2,this.smoothingLayers.volumeSmooth1,.06,s),this.smoothingLayers.volumeFinal=this.lerp(this.smoothingLayers.volumeFinal,this.smoothingLayers.volumeSmooth2,.03,s),this.volume=this.smoothingLayers.volumeFinal,v>this.peak&&(this.peak=this.lerp(this.peak,v,.3,s)),this.peak=this.lerp(this.peak,this.beatMin,.01,s),this.peak=Math.max(this.peak,this.beatMin),this.beatDetected=!1;const x=Date.now();v>this.peak*this.beatThreshold&&x-this.lastBeatTime>150&&(this.beatDetected=!0,this.beatInterval=x-this.lastBeatTime,this.lastBeatTime=x),this.isActive&&requestAnimationFrame(()=>this.analyze())}getFrequencyData(){return!this.isActive||!this.dataArray?null:this.dataArray}getFFTData(){return!this.isActive||!this.dataArray?null:new Uint8Array(this.dataArray)}getMetrics(){return{volume:this.volume,bass:this.bass,mid:this.mid,treble:this.treble,beat:this.beatDetected,beatInterval:this.beatInterval,isActive:this.isActive,isMicrophoneMode:this.isMicrophoneMode,isMusicMode:this.isMusicMode,isMusicPlaying:this.isMusicPlaying()}}}const we=[{from:"bass",to:"breath",gain:1.4,curve:"easeExp"},{from:"bass",to:"luminance",gain:.6},{from:"mid",to:"hueDrift",gain:.3},{from:"treble",to:"sliceJitter",gain:.5},{from:"beat",to:"pulseKick",gain:1}],se={linear:n=>n,easeExp:n=>n*n,easeSqrt:n=>Math.sqrt(n),easeIn:n=>n*n*n,easeOut:n=>1-Math.pow(1-n,3)};function Le(n,e){const s={};return we.forEach(a=>{const i=n[a.from]||0,r=(se[a.curve]||se.linear)(i)*a.gain;s[a.to]?s[a.to]+=r:s[a.to]=r}),s}const De={Calm:[{from:"bass",to:"breath",gain:.8,curve:"easeSqrt"},{from:"bass",to:"luminance",gain:.3},{from:"mid",to:"hueDrift",gain:.2},{from:"treble",to:"sliceJitter",gain:.2}],Pulse:[{from:"bass",to:"breath",gain:1.4,curve:"easeExp"},{from:"bass",to:"luminance",gain:.6},{from:"mid",to:"hueDrift",gain:.3},{from:"treble",to:"sliceJitter",gain:.5},{from:"beat",to:"pulseKick",gain:1}],Rave:[{from:"bass",to:"breath",gain:2,curve:"easeExp"},{from:"bass",to:"luminance",gain:.9,curve:"easeExp"},{from:"mid",to:"hueDrift",gain:.5},{from:"treble",to:"sliceJitter",gain:.8},{from:"beat",to:"pulseKick",gain:1.5},{from:"treble",to:"ribbonHeight",gain:1.2}]};function Re(n){return De[n]||we}class Me{constructor(e){this.audio=e,this.isActive=!1,this.config={bassToPulse:1,bassToRotation:.05,bassToSize:1.5,midToSlices:.01,trebleToHue:.05,beatImpact:.45,beatDecay:.96,rotationSmoothing:.995,sizeSmoothing:.96,hueSmoothing:.998,parameterSmoothing:.98,userInteractionWeight:1,audioOnlyWeight:1,userFullControlWeight:1,maxRotationSpeed:.15,maxSizeVariation:.6,maxHueSpeed:10},this.beatPulse=0,this.beatPhase=0,this.smoothedValues={bass:0,rotation:0,size:0,hue:0,breathing:0,volume:0},this.targetValues={swirlSpeed:0,sizeMod:0,baseRadius:0,circles:0,hueSpeed:0,slices:0},this.currentValues={...this.targetValues},this.userInteraction={isActive:!1,lastInteractionTime:0,userValues:{...this.targetValues},interactionDecay:1,interactionThreshold:2e3},this.baseValues={...t},this.lastUpdateTime=performance.now()}lerp(e,s,a,i=1){const o=1-Math.pow(1-a,i*60/1e3);return e+(s-e)*o}easeInOutCubic(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}onUserInteraction(e,s){this.userInteraction.isActive=!0,this.userInteraction.lastInteractionTime=performance.now(),this.userInteraction.userValues.hasOwnProperty(e)&&(this.userInteraction.userValues[e]=s)}updateUserInteraction(){return performance.now()-this.userInteraction.lastInteractionTime>this.userInteraction.interactionThreshold&&(this.userInteraction.isActive=!1),this.userInteraction.isActive?1:0}start(){this.isActive=!0,this.baseValues={...t},Object.keys(this.targetValues).forEach(e=>{t.hasOwnProperty(e)&&(this.targetValues[e]=t[e],this.currentValues[e]=t[e],this.userInteraction.userValues[e]=t[e])}),this.targetValues.luminance=t.luminance||.6,this.targetValues.hueDrift=t.hueDrift||0,this.currentValues.luminance=t.luminance||.6,this.currentValues.hueDrift=t.hueDrift||0,this.userInteraction.userValues.luminance=t.luminance||.6,this.userInteraction.userValues.hueDrift=t.hueDrift||0,this.lastUpdateTime=performance.now()}stop(){this.isActive=!1,this.userInteraction.isActive=!1}update(){if(!this.isActive||!this.audio.isActive)return;const e=performance.now(),s=e-this.lastUpdateTime;this.lastUpdateTime=e;const a=this.audio.getMetrics(),i=Re(l.mode),o=this.updateUserInteraction();this.smoothedValues.bass=this.lerp(this.smoothedValues.bass,a.bass,.08,s),this.smoothedValues.volume=this.lerp(this.smoothedValues.volume,a.volume,.06,s),a.bass,a.mid,a.treble,a.beat;const r=Le(i);a.beat&&a.bass>.4&&(this.beatPulse=Math.max(this.beatPulse,this.config.beatImpact),this.beatPhase=0),this.beatPulse=this.lerp(this.beatPulse,0,.04,s),this.beatPhase+=.08*(s/16.67);const b=this.smoothedValues.bass*this.config.bassToPulse,h=this.beatPulse*Math.sin(this.beatPhase*Math.PI)*.8,c=this.smoothedValues.bass*this.config.bassToRotation;this.smoothedValues.rotation=this.lerp(this.smoothedValues.rotation,c,1-this.config.rotationSmoothing,s);const m=b+h;this.smoothedValues.size=this.lerp(this.smoothedValues.size,m,1-this.config.sizeSmoothing,s),this.smoothedValues.breathing=this.lerp(this.smoothedValues.breathing,this.smoothedValues.size,.05,s);const p=a.treble*this.config.trebleToHue*10;this.smoothedValues.hue=this.lerp(this.smoothedValues.hue,p,1-this.config.hueSmoothing,s);const w={swirlSpeed:this.baseValues.swirlSpeed+Math.max(-this.config.maxRotationSpeed,Math.min(this.config.maxRotationSpeed,this.smoothedValues.rotation)),sizeMod:0,baseRadius:0,circles:this.baseValues.circles,hueSpeed:Math.max(5,Math.min(this.config.maxHueSpeed,this.baseValues.hueSpeed+this.smoothedValues.hue)),slices:this.baseValues.slices,luminance:t.luminance,hueDrift:t.hueDrift};if(r.breath){const u=Math.min(1,r.breath);w.baseRadius=this.baseValues.baseRadius*(1+u*.3),w.sizeMod=this.baseValues.sizeMod*(1+u*.2)}if(r.luminance&&(w.luminance=Math.max(.3,Math.min(1,this.baseValues.luminance+r.luminance*.4))),r.hueDrift&&(w.hueDrift=Math.max(-1,Math.min(1,r.hueDrift))),r.sliceJitter&&Math.random()<.1){const u=Math.floor(r.sliceJitter*3);w.slices=Math.max(4,Math.min(20,this.baseValues.slices+(Math.random()>.5?u:-u)))}r.pulseKick&&(this.beatPulse=Math.max(this.beatPulse,r.pulseKick));const y=Math.min(this.config.maxSizeVariation,this.smoothedValues.breathing),S=Math.sin(this.beatPhase*Math.PI*.5),v=this.easeInOutCubic(S),x=1-y*.4*(1-v);if(w.sizeMod=Math.max(.05,Math.min(.35,this.baseValues.sizeMod*x)),w.baseRadius=Math.max(.15,Math.min(.5,this.baseValues.baseRadius*(x*.8))),this.smoothedValues.bass>.5&&(w.circles=Math.max(3,this.baseValues.circles-Math.floor(this.smoothedValues.bass*2))),a.beat&&Math.random()>.98){const u=Math.random()>.5?1:-1;w.slices=Math.max(4,Math.min(12,this.baseValues.slices+u))}Object.keys(this.targetValues).forEach(u=>{o>0?this.targetValues[u]=this.userInteraction.userValues[u]:this.targetValues[u]=w[u]||this.targetValues[u],this.currentValues[u]=this.lerp(this.currentValues[u],this.targetValues[u],1-this.config.parameterSmoothing,s),t.hasOwnProperty(u)&&(t[u]=this.currentValues[u])})}returnToBase(){const e=performance.now(),s=e-this.lastUpdateTime;this.lastUpdateTime=e,Object.keys(this.baseValues).forEach(i=>{typeof t[i]=="number"&&(this.currentValues[i]=this.lerp(this.currentValues[i],this.baseValues[i],.02,s),t[i]=this.currentValues[i])}),!Object.keys(this.baseValues).every(i=>typeof t[i]=="number"?Math.abs(t[i]-this.baseValues[i])<.01:!0)&&!this.isActive&&requestAnimationFrame(()=>this.returnToBase())}applySpecialEffects(e){if(!this.isActive||!this.audio.isActive||this.updateUserInteraction()>.7)return;const i=performance.now()-this.lastUpdateTime;if(this.smoothedValues.bass>.7){const o=(this.smoothedValues.bass-.7)*2,r=this.lerp(0,o*.2,.05,i);this.targetValues.baseRadius=Math.max(.1,this.baseValues.baseRadius*(1-r)),this.targetValues.sizeMod=Math.max(.05,this.baseValues.sizeMod*(1-r*.75))}if(this.smoothedValues.volume<.1){const o=Math.sin(Date.now()*.001)*.02+1,r=this.lerp(1,o,.03,i);this.targetValues.sizeMod=Math.min(.35,this.baseValues.sizeMod*r),this.targetValues.baseRadius=Math.min(.5,this.baseValues.baseRadius*r),this.targetValues.swirlSpeed=this.baseValues.swirlSpeed*.3}if(this.smoothedValues.bass>.3&&this.smoothedValues.bass<.7){const o=this.smoothedValues.bass*.05;this.targetValues.swirlSpeed=this.lerp(this.targetValues.swirlSpeed,this.targetValues.swirlSpeed+o,.02,i)}}}class Se{constructor(e){this.audio=e,this.enabled=!1,this.config={fftBins:64,minRadius:.15,maxRadius:.45,baseHeight:.05,maxHeight:.3,heightPower:1.3,smoothing:.85,colorOffset:60,baseAlpha:.6,glowStrength:.8,rotationSpeed:.2},this.smoothedHeights=new Float32Array(this.config.fftBins),this.rotation=0,this.lastTime=performance.now()}enable(){this.enabled=!0}disable(){this.enabled=!1}draw(e){if(!this.enabled||!this.audio||!this.audio.isActive)return;const s=performance.now(),a=(s-this.lastTime)/1e3;this.lastTime=s;const i=this.audio.getFFTData();if(!i||i.length===0)return;this.rotation+=t.swirlSpeed*this.config.rotationSpeed*a,d.save(),d.translate(Z,ee),d.rotate(this.rotation);const o=Math.min(E,C),r=o*this.config.minRadius,h=o*this.config.maxRadius-r,c=Math.floor(i.length/this.config.fftBins),m=Math.PI*2/this.config.fftBins,p=t.luminance||.6,w=t.hueDrift||0;for(let y=0;y<this.config.fftBins;y++){let S=0;const v=y*c,x=Math.min(v+c,i.length);for(let j=v;j<x;j++)S+=i[j];S=S/(x-v)/255,S=Math.pow(S,this.config.heightPower),this.smoothedHeights[y]=this.smoothedHeights[y]*this.config.smoothing+S*(1-this.config.smoothing);const u=y*m,H=this.config.baseHeight+this.smoothedHeights[y]*this.config.maxHeight,K=h*H,$=(e*t.hueSpeed+y*this.config.colorOffset+w*90)%360,N=this.config.baseAlpha*p*(.5+this.smoothedHeights[y]*.5);d.save(),d.rotate(u);const U=d.createLinearGradient(0,r,0,r+K);U.addColorStop(0,`hsla(${$}, 100%, ${60*p}%, ${N})`),U.addColorStop(.5,`hsla(${$}, 90%, ${50*p}%, ${N*.8})`),U.addColorStop(1,`hsla(${$}, 80%, ${30*p}%, 0)`),d.fillStyle=U,d.fillRect(-m*r*.4,r,m*r*.8,K),this.smoothedHeights[y]>.3&&(d.shadowBlur=20*this.config.glowStrength,d.shadowColor=`hsla(${$}, 100%, ${70*p}%, ${N})`,d.fillRect(-m*r*.3,r,m*r*.6,K*.8),d.shadowBlur=0),d.restore()}d.restore()}setMode(e){switch(e){case"Calm":this.config.maxHeight=.2,this.config.baseAlpha=.4,this.config.glowStrength=.5;break;case"Pulse":this.config.maxHeight=.3,this.config.baseAlpha=.6,this.config.glowStrength=.8;break;case"Rave":this.config.maxHeight=.4,this.config.baseAlpha=.8,this.config.glowStrength=1,this.enable();break}}}class ve{constructor(){this.canvas=null,this.ctx=null,this.visible=!1,this.fps=0,this.frameCount=0,this.lastTime=performance.now(),this.lastFPSUpdate=this.lastTime,this.audioAnalyzer=null,this.gestures=[{gesture:"Single finger wheel",action:"Spin speed",icon:"🔄"},{gesture:"Two-finger pinch",action:"Scale pattern",icon:"🔍"},{gesture:"Two-finger rotate",action:"Hue drift",icon:"🎨"},{gesture:"3-finger vertical",action:"Brightness",icon:"☀️"},{gesture:"Double-tap",action:"Mode cycle",icon:"🔄"},{gesture:"Long press 400ms",action:"Toggle HUD",icon:"📊"}],this.createCanvas()}createCanvas(){this.canvas=document.createElement("canvas"),this.canvas.id="hud",this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="1000",this.canvas.style.display="none",document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const e=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*e,this.canvas.height=window.innerHeight*e,this.ctx.scale(e,e)}setAudioAnalyzer(e){this.audioAnalyzer=e}toggle(){this.visible=!this.visible,this.canvas.style.display=this.visible?"block":"none"}show(){this.visible=!0,this.canvas.style.display="block"}hide(){this.visible=!1,this.canvas.style.display="none"}update(){if(!this.visible)return;const e=performance.now();this.frameCount++,e-this.lastFPSUpdate>500&&(this.fps=Math.round(this.frameCount*1e3/(e-this.lastFPSUpdate)),this.frameCount=0,this.lastFPSUpdate=e),this.draw()}draw(){const e=this.ctx,s=window.innerWidth,a=window.innerHeight;e.clearRect(0,0,s,a),e.font="12px monospace",e.fillStyle="rgba(255, 255, 255, 0.9)",e.strokeStyle="rgba(0, 0, 0, 0.5)",e.lineWidth=3;const i=`FPS: ${this.fps}`;e.strokeText(i,10,20),e.fillText(i,10,20);let o=40;if([{name:"Mode",value:l.mode},{name:"Swirl",value:t.swirlSpeed.toFixed(2)},{name:"Scale",value:l.scale.toFixed(2)},{name:"Luminance",value:t.luminance.toFixed(2)},{name:"Hue Drift",value:t.hueDrift.toFixed(2)},{name:"Base Radius",value:t.baseRadius.toFixed(2)},{name:"Slices",value:t.slices},{name:"Circles",value:t.circles}].forEach(h=>{const c=`${h.name}: ${h.value}`;e.strokeText(c,10,o),e.fillText(c,10,o),o+=15}),this.audioAnalyzer&&this.audioAnalyzer.isActive){const h=this.audioAnalyzer.getMetrics();o+=10,e.fillStyle="rgba(100, 255, 100, 0.9)",[{name:"Volume",value:h.volume.toFixed(2)},{name:"Bass",value:h.bass.toFixed(2)},{name:"Mid",value:h.mid.toFixed(2)},{name:"Treble",value:h.treble.toFixed(2)},{name:"Beat",value:h.beat?"🎵":"-"}].forEach(m=>{const p=`${m.name}: ${m.value}`;e.strokeText(p,10,o),e.fillText(p,10,o),o+=15})}if(this.audioAnalyzer&&this.audioAnalyzer.isActive){const h=this.audioAnalyzer.getFFTData();if(h){e.save(),e.translate(10,o+10),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,0,100,50);const c=100/32,m=Math.floor(h.length/32);e.fillStyle="rgba(100, 255, 100, 0.8)";for(let p=0;p<32;p++){const y=h[p*m]/255*45;e.fillRect(p*c,50-y,c-1,y)}e.restore()}}e.save(),e.font="11px monospace",e.textAlign="right",o=20,e.fillStyle="rgba(255, 255, 200, 0.9)";const b="Gestures:";e.strokeText(b,s-10,o),e.fillText(b,s-10,o),o+=20,e.fillStyle="rgba(255, 255, 255, 0.8)",this.gestures.forEach(h=>{const c=`${h.icon} ${h.gesture}: ${h.action}`;e.strokeText(c,s-10,o),e.fillText(c,s-10,o),o+=15}),e.restore()}}console.log("🎨 Dream-Kaleido-Flow v1.5.0 - Mobile Light Toy 2.0");console.log("🚀 Multi-channel physics, audio ribbons, brightness control");ue();V();setTimeout(()=>{V()},10);const P=new ye,L=new Me(P),xe=new Se(P),te=new ve;Pe(xe);te.setAudioAnalyzer(P);me(te);"ontouchstart"in window?(fe(A,L),ge(L)):(de(),pe(L),be(A,L));let ie=performance.now();function Ie(n){const e=n-ie;if(ie=n,Ve(e),"ontouchstart"in window||Ae(),P.isActive){L.update(),xe.setMode(l.mode);const s=document.getElementById("audioLevel"),a=s==null?void 0:s.querySelector(".bar");if(a){const i=P.getMetrics();a.style.transform=`scaleX(${i.volume})`}L.applySpecialEffects(P.getMetrics())}te.update()}document.body.addEventListener("touchmove",n=>{n.preventDefault()},{passive:!1});document.addEventListener("visibilitychange",()=>{});setTimeout(()=>{requestAnimationFrame(W)},100);const k=document.getElementById("playBtn"),J=document.getElementById("audioBtn"),ae=document.getElementById("audioLevel"),oe=k.querySelector(".play-icon"),ne=k.querySelector(".pause-icon");function D(){const n=P.getMetrics();n.isMusicPlaying?(k.classList.add("playing"),oe.style.display="none",ne.style.display="block"):(k.classList.remove("playing"),oe.style.display="block",ne.style.display="none"),n.isMicrophoneMode?J.classList.add("active"):J.classList.remove("active"),n.isActive?ae.classList.add("visible"):ae.classList.remove("visible")}k.addEventListener("click",async()=>{P.getMetrics().isMusicMode?P.toggleMusic()===null?alert("Could not control music playback."):D():await P.startMusic()?(L.start(),D()):alert("Could not start music playback. Please check if the audio file is available.")});J.addEventListener("click",async()=>{P.getMetrics().isMicrophoneMode?(P.stop(),L.stop(),D()):await P.startMicrophone()?(L.start(),D()):alert("Could not access microphone. Please check permissions.")});setInterval(D,100);const Y=document.getElementById("musicPlayer");Y&&(Y.addEventListener("ended",()=>{D()}),Y.addEventListener("pause",()=>{D()}),Y.addEventListener("play",()=>{D()}));let _=null;function Pe(n){_=n}function ze(n){const{circles:e,baseRadius:s,sizeMod:a,hueSpeed:i,luminance:o,hueDrift:r}=t,b=E||100,h=C||100,c=Math.min(b,h);if(!isFinite(c)||c<=0){console.warn("Invalid containerSize:",c,"w:",b,"h:",h);return}for(let m=0;m<e;m++){const p=m/e*Math.PI*2+n*.7,w=s*c+Math.sin(n+m)*40,y=Math.cos(p)*w,S=Math.sin(p)*w,v=(30+Math.sin(n*1.2+m*.7)*20)*(1+a*Math.sin(n*.3+m)),x=(n*i+m*50+r*90)%360;if(!isFinite(y)||!isFinite(S)||!isFinite(v)||!isFinite(w)||!isFinite(p)||!isFinite(x)||v<=0||w<0){console.warn("Invalid drawing values:",{x:y,y:S,size:v,r:w,angle:p,hue:x});continue}const u=d.createRadialGradient(y,S,0,y,S,v);u.addColorStop(0,`hsla(${x},100%,${70*o}%,1)`),u.addColorStop(.3,`hsla(${x},100%,${60*o}%,0.9)`),u.addColorStop(.7,`hsla(${(x+120)%360},90%,${40*o}%,0.4)`),u.addColorStop(1,`hsla(${(x+180)%360},80%,${20*o}%,0)`),d.fillStyle=u,d.beginPath(),d.arc(y,S,v,0,Math.PI*2),d.fill(),m%2===0&&(d.strokeStyle=`hsla(${x},100%,${80*o}%,0.3)`,d.lineWidth=.5*I,d.stroke())}}function W(n){const e=n*.001;if(Ie(n),!E||!C||E<=0||C<=0){requestAnimationFrame(W);return}d.clearRect(0,0,E,C),_&&l.mode==="Rave"&&_.draw(e),d.save(),d.translate(Z,ee);const{slices:s,swirlSpeed:a}=t,i=Math.PI*2/s;for(let o=0;o<s;o++)d.save(),d.rotate(i*o+e*a),o&1&&d.scale(-1,1),ze(e),d.restore();d.restore(),requestAnimationFrame(W)}console.log("🎨 Dream-Kaleido-Flow v1.5.0 - Mobile Light Toy 2.0");console.log("🚀 Multi-channel physics, audio ribbons, brightness control");ue();V();setTimeout(()=>{V()},10);const T=new ye,z=new Me(T),Ee=new Se(T),Te=new ve;Pe(Ee);Te.setAudioAnalyzer(T);me(Te);"ontouchstart"in window?(fe(A,z),ge(z)):(de(),pe(z),be(A,z));performance.now();document.body.addEventListener("touchmove",n=>{n.preventDefault()},{passive:!1});document.addEventListener("visibilitychange",()=>{});setTimeout(()=>{requestAnimationFrame(W)},100);const B=document.getElementById("playBtn"),Q=document.getElementById("audioBtn"),re=document.getElementById("audioLevel"),le=B.querySelector(".play-icon"),ce=B.querySelector(".pause-icon");function R(){const n=T.getMetrics();n.isMusicPlaying?(B.classList.add("playing"),le.style.display="none",ce.style.display="block"):(B.classList.remove("playing"),le.style.display="block",ce.style.display="none"),n.isMicrophoneMode?Q.classList.add("active"):Q.classList.remove("active"),n.isActive?re.classList.add("visible"):re.classList.remove("visible")}B.addEventListener("click",async()=>{T.getMetrics().isMusicMode?T.toggleMusic()===null?alert("Could not control music playback."):R():await T.startMusic()?(z.start(),R()):alert("Could not start music playback. Please check if the audio file is available.")});Q.addEventListener("click",async()=>{T.getMetrics().isMicrophoneMode?(T.stop(),z.stop(),R()):await T.startMicrophone()?(z.start(),R()):alert("Could not access microphone. Please check permissions.")});setInterval(R,100);const O=document.getElementById("musicPlayer");O&&(O.addEventListener("ended",()=>{R()}),O.addEventListener("pause",()=>{R()}),O.addEventListener("play",()=>{R()}));
