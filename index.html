<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>Dream‑Kaleido‑Flow</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  html, body {
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: none;
  }
  
  body {
    position: relative; /* Allow keyboard to push content */
  }
  
  canvas {
    display: block;
    width: 100vw;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    cursor: move;
    background: #000;
    /* Ensure no gaps or artifacts */
    image-rendering: auto;
    -ms-interpolation-mode: bicubic;
  }
  
  /* Prevent bounce on iOS */
  body {
    overscroll-behavior: none;
  }
  
  /* Audio controls container - mobile first design */
  #audioControls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    gap: 20px;
    align-items: center;
    /* Ensure buttons are accessible above audio bar */
    padding-bottom: 5px;
  }
  
  /* Base button styles - mobile optimized */
  .audio-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.6);
    width: 54px;
    height: 54px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    /* Better touch targets for mobile */
    -webkit-tap-highlight-color: transparent;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  
  .audio-btn:hover,
  .audio-btn:active {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.8);
    transform: scale(1.05);
  }
  
  .audio-btn.active {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.15);
    animation: gentleGlow 3s ease-in-out infinite;
  }
  
  @keyframes gentleGlow {
    0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); }
    50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.2); }
  }
  
  .audio-btn svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
  }
  
  /* Play button specific styling */
  #playBtn.playing {
    background: rgba(0, 255, 100, 0.1);
    border-color: rgba(0, 255, 100, 0.3);
    color: rgba(0, 255, 100, 0.9);
    animation: playGlow 2s ease-in-out infinite;
  }
  
  @keyframes playGlow {
    0%, 100% { box-shadow: 0 0 15px rgba(0, 255, 100, 0.2); }
    50% { box-shadow: 0 0 35px rgba(0, 255, 100, 0.3); }
  }
  
  /* Audio level indicator - full width rainbow line at bottom */
  #audioLevel {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: rgba(0, 0, 0, 0.3);
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.5s ease;
    z-index: 999; /* Below controls */
  }
  
  #audioLevel.visible {
    opacity: 1;
  }
  
  #audioLevel .bar {
    height: 100%;
    background: linear-gradient(90deg, 
      #ff0080 0%, 
      #ff8000 20%, 
      #ffff00 40%, 
      #00ff00 60%, 
      #00ffff 80%, 
      #ff00ff 100%);
    transform-origin: left;
    transform: scaleX(0);
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
  }
  
  /* Mobile optimizations */
  @media (max-width: 768px) {
    /* Handle notch/safe areas on modern phones */
    @supports (padding: env(safe-area-inset-bottom)) {
      #audioControls {
        bottom: calc(20px + env(safe-area-inset-bottom));
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }
    
    /* Larger touch targets for mobile */
    .audio-btn {
      width: 58px;
      height: 58px;
      border-width: 2px;
    }
    
    .audio-btn svg {
      width: 26px;
      height: 26px;
    }
    
    /* Audio level more prominent on mobile */
    #audioLevel {
      height: 5px;
    }
    
    /* Ensure canvas interaction works everywhere */
    canvas {
      touch-action: manipulation;
    }
  }
  
  /* Very small screens (phones in portrait) */
  @media (max-width: 480px) and (max-height: 800px) {
    #audioControls {
      gap: 15px;
      bottom: 15px;
    }
    
    .audio-btn {
      width: 52px;
      height: 52px;
    }
    
    .audio-btn svg {
      width: 22px;
      height: 22px;
    }
  }
  
  /* Landscape mobile */
  @media (max-height: 500px) and (orientation: landscape) {
    #audioControls {
      bottom: 10px;
      gap: 15px;
    }
    
    .audio-btn {
      width: 48px;
      height: 48px;
    }
    
    .audio-btn svg {
      width: 20px;
      height: 20px;
    }
    
    #audioLevel {
      height: 3px;
    }
  }
  
  /* Desktop enhancements */
  @media (min-width: 769px) {
    .audio-btn {
      width: 48px;
      height: 48px;
      border-width: 1px;
    }
    
    .audio-btn svg {
      width: 22px;
      height: 22px;
    }
    
    .audio-btn:hover {
      transform: scale(1.1);
    }
    
    #audioLevel {
      height: 3px;
    }
  }
</style>
</head>
<body>
<canvas id="c"></canvas>

<!-- Audio Controls -->
<div id="audioControls">
  <button id="playBtn" class="audio-btn" aria-label="Play/Pause Music">
    <svg class="play-icon" viewBox="0 0 24 24">
      <path d="M8 5v14l11-7z"/>
    </svg>
    <svg class="pause-icon" viewBox="0 0 24 24" style="display: none;">
      <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
    </svg>
  </button>
  
  <button id="audioBtn" class="audio-btn" aria-label="Toggle Microphone">
    <svg viewBox="0 0 24 24">
      <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
    </svg>
  </button>
</div>

<div id="audioLevel">
  <div class="bar"></div>
</div>

<!-- Hidden audio element for MP3 playback -->
<audio id="musicPlayer" preload="auto" loop>
  <source src="Dea_Fungorum_cut_fadeout.mp3" type="audio/mpeg">
</audio>

<!-- Load Hammer.js from CDN for touch gestures -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

<!-- Cache busted JavaScript modules -->
<script type="module" src="js/main.js?v=1.2.0-20241227"></script>

<!-- Register Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => console.log('SW registered:', registration))
      .catch(error => console.log('SW registration failed:', error));
  });
}
</script>
</body>
</html>